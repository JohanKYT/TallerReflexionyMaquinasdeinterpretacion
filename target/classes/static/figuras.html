<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gestor de Figuras Geométricas</title>
    <style>
        body { font-family: Arial; margin: 30px; }
        input, textarea, button { margin: 5px 0; padding: 5px; width: 300px; }
        table { width: 80%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; }
        .param-input { width: 50px; margin-right: 5px; }
    </style>
</head>
<body>
<h1>Gestor de Figuras Geométricas</h1>

<div>
    <h3>Crear Figura Nativa</h3>
    <input type="text" id="nombre" placeholder="Nombre (Circulo, Rectangulo, Triangulo)">
    <input type="text" id="valores" placeholder="Valores separados por coma"><br>
    <button onclick="crearFigura()">Crear Figura</button>
</div>

<hr>

<div>
    <h3>Crear Figura Dinámica (Groovy)</h3>
    <textarea id="codigo" rows="8" placeholder="Escribe tu clase Groovy aquí"></textarea><br>
    <div id="parametrosGroovy"></div>
    <button onclick="crearFiguraGroovy()">Ejecutar Groovy</button>
</div>

<hr>

<h3>Figuras creadas:</h3>
<table>
    <thead>
    <tr><th>#</th><th>Figura</th><th>Área</th><th>Perímetro</th></tr>
    </thead>
    <tbody id="tablaFiguras"></tbody>
</table>

<script>
    const nombreInput = document.getElementById('nombre');
    const valoresInput = document.getElementById('valores');
    const codigoInput = document.getElementById('codigo');
    const parametrosGroovyDiv = document.getElementById('parametrosGroovy');

    // Placeholder dinámico para figuras nativas
    nombreInput.addEventListener('blur', async () => {
        const nombre = nombreInput.value.trim();
        if(!nombre) return;
        try {
            const res = await fetch('/figuras/params?nombre=' + nombre);
            const params = await res.json();
            valoresInput.placeholder = params.join(', ');
        } catch(e) {
            valoresInput.placeholder = 'Figura no encontrada';
        }
    });

    // ================================================================
    // BLOQUE CORREGIDO 1: Detectar constructor Groovy
    // ================================================================
    codigoInput.addEventListener('blur', () => {
        const codigo = codigoInput.value.trim();
        parametrosGroovyDiv.innerHTML = ''; // limpiar inputs anteriores
        if (!codigo) return;

        // --- LÓGICA MEJORADA ---

        // 1. Encontrar el nombre de la clase
        const classNameMatch = codigo.match(/class\s+(\w+)/);
        if (!classNameMatch) {
            console.warn("No se encontró 'class' en el código.");
            return; // No hay 'class'
        }
        const className = classNameMatch[1]; // E.g., "Pentagono"

        // 2. Crear una regex para BUSCAR ESE CONSTRUCTOR
        // E.g., new RegExp("Pentagono\\s*\\(([^)]*)\\)")
        const constructorRegex = new RegExp(className + '\\s*\\(([^)]*)\\)');
        const constructorLineMatch = codigo.match(constructorRegex);

        let params = [];

        // 3. Revisar si se encontró el constructor Y si tiene parámetros
        if (constructorLineMatch && constructorLineMatch[1].trim().length > 0) {
            // constructorLineMatch[1] es "double lado" o "double base, double altura"
            params = constructorLineMatch[1].split(',').map(p => p.trim().split(' ').pop());
        }

        // --- FIN DE LÓGICA MEJORADA ---

        // Si no se encontró constructor o no tiene parámetros, no se crean inputs
        if (params.length === 0) {
            console.log("No se detectaron parámetros de constructor.");
            return;
        }

        // Crear inputs para cada parámetro detectado
        params.forEach(p => {
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'param-input';
            input.placeholder = p; // Solo el nombre
            input.value = 1;
            // Guardamos el nombre del parámetro de forma segura
            input.dataset.name = p;

            // (Opcional) Añadir una etiqueta
            const label = document.createElement('label');
            label.innerText = ` ${p}: `;
            parametrosGroovyDiv.appendChild(label);
            parametrosGroovyDiv.appendChild(input);
        });
    });

    // Crear figura nativa
    async function crearFigura() {
        const nombre = nombreInput.value.trim();
        if(!nombre) return alert("Ingrese nombre de la figura");

        const valores = valoresInput.value.split(',').map(v => parseFloat(v.trim()));
        const res = await fetch(`/figuras/crearRapido?nombre=${nombre}&` +
            valores.map(v => `valores=${v}`).join('&'), { method: 'GET' });
        await res.json(); // usamos DTO

        nombreInput.value = '';
        valoresInput.value = '';
        cargarFiguras();
    }

    // ================================================================
    // BLOQUE CORREGIDO 2: Crear figura Groovy
    // ================================================================
    async function crearFiguraGroovy() {
        const codigo = codigoInput.value.trim();
        if (!codigo) return alert("Ingrese código Groovy");

        // Tomamos todos los inputs de parámetros generados
        const inputs = parametrosGroovyDiv.querySelectorAll('input');
        const parametros = {};

        inputs.forEach((input) => {
            // Leemos el nombre desde 'data-name' (más robusto)
            const nombre = input.dataset.name;
            parametros[nombre] = parseFloat(input.value);
        });

        try {
            const res = await fetch('/figuras/crearGroovy?codigo=' + encodeURIComponent(codigo), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(parametros) // ahora enviamos un objeto
            });

            if (!res.ok) {
                const text = await res.text();
                console.error('Error Groovy:', text);
                alert('Error al crear figura Groovy: ' + text);
                return;
            }

            // Limpiamos inputs
            codigoInput.value = '';
            parametrosGroovyDiv.innerHTML = '';
            cargarFiguras();
        } catch (e) {
            console.error(e);
            alert('Error de conexión con el servidor.');
        }
    }

    // Listar figuras
    async function cargarFiguras() {
        const res = await fetch('/figuras/listar');
        const figuras = await res.json();
        const tbody = document.querySelector('#tablaFiguras');
        tbody.innerHTML = '';
        figuras.forEach((f, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i+1}</td><td>${f.nombre}</td><td>${f.area}</td><td>${f.perimetro}</td>`;
            tbody.appendChild(tr);
        });
    }

    // Cargar tabla al abrir la página
    cargarFiguras();
</script>
</body>
</html>